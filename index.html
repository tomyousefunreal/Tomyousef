<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة السعرات المصري</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* نفس الـ CSS من الكود الأصلي بدون تغيير للاختصار */
        /* لو عايز الـ CSS كامل، قوللي وأضيفه */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Arial', sans-serif; background: linear-gradient(135deg, #e0f7fa, #b2ebf2); padding: 15px; }
        body.dark-mode { background: linear-gradient(135deg, #263238, #455a64); color: #eceff1; }
        .container { max-width: 1600px; margin: 20px auto; background: #fff; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        .navbar { display: flex; justify-content: space-around; background: #0288d1; padding: 15px; border-radius: 12px; }
        .nav-item { color: white; cursor: pointer; padding: 10px 20px; border-radius: 10px; }
        .header h1 { color: #0277bd; font-size: 2.5em; text-align: center; }
        .login-container, .stats, .meals { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
        .login-box, .stat-box, .meal-box { background: #e1f5fe; padding: 20px; border-radius: 12px; text-align: center; }
        .hidden { display: none !important; }
        button, input, select { padding: 10px; border-radius: 8px; margin: 5px 0; width: 100%; }
        button { background: #0288d1; color: white; border: none; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; }
    </style>
</head>
<body>
    <div class="container">
        <nav class="navbar hidden" id="navbar">
            <div class="nav-item" onclick="showSection('owner-meals')"><i class="fas fa-users"></i> إدارة العملاء</div>
            <div class="nav-item" onclick="showSection('add-client-form')"><i class="fas fa-user-plus"></i> إضافة عميل</div>
            <div class="nav-item" onclick="toggleTheme()"><i class="fas fa-adjust"></i> تغيير الثيم</div>
            <div class="nav-item" onclick="clearDatabase()"><i class="fas fa-trash-alt"></i> حذف قاعدة البيانات</div>
            <div class="nav-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</div>
        </nav>

        <div class="header">
            <h1>نظام إدارة السعرات المصري</h1>
        </div>

        <div class="breadcrumbs hidden" id="breadcrumbs">الرئيسية</div>

        <div class="login-container" id="login-screen">
            <div class="login-box">
                <h3><i class="fas fa-sign-in-alt"></i> تسجيل الدخول</h3>
                <select id="user-type">
                    <option value="owner">المالك</option>
                    <option value="client">العميل</option>
                </select>
                <input type="text" id="username" placeholder="اسم المستخدم">
                <input type="password" id="password" placeholder="كلمة المرور">
                <button onclick="login()"><i class="fas fa-sign-in-alt"></i> تسجيل الدخول</button>
            </div>
        </div>

        <div class="owner-only hidden" id="owner-interface">
            <div id="add-client-form" class="hidden">
                <h2><i class="fas fa-user-plus"></i> إضافة عميل جديد</h2>
                <input type="text" id="client-username" placeholder="اسم المستخدم للعميل">
                <input type="password" id="client-password" placeholder="كلمة المرور للعميل">
                <input type="number" id="client-age" placeholder="العمر">
                <input type="number" id="client-height" placeholder="الطول (سم)">
                <input type="number" id="client-weight" placeholder="الوزن (كجم)">
                <select id="client-gender">
                    <option value="male">ذكر</option>
                    <option value="female">أنثى</option>
                </select>
                <select id="client-activity">
                    <option value="1.2">قليل النشاط</option>
                    <option value="1.375">خفيف</option>
                    <option value="1.55">متوسط</option>
                    <option value="1.725">نشط</option>
                </select>
                <select id="client-goal">
                    <option value="loss">فقدان الوزن</option>
                    <option value="gain">زيادة الوزن</option>
                    <option value="maintain">المحافظة على الوزن</option>
                </select>
                <input type="number" id="target-calories" placeholder="السعرات المستهدفة (اختياري)">
                <input type="number" id="protein-grams" placeholder="جرام بروتين">
                <input type="number" id="carbs-grams" placeholder="جرام كارب">
                <input type="number" id="fats-grams" placeholder="جرام دهون">
                <input type="number" id="fiber-grams" placeholder="جرام ألياف">
                <input type="number" id="usage-days" placeholder="عدد أيام الاستخدام">
                <select id="client-lifestyle">
                    <option value="sedentary">جالس (مكتبي)</option>
                    <option value="active">نشط (رياضي)</option>
                    <option value="mixed">مختلط</option>
                </select>
                <button onclick="addClient()"><i class="fas fa-save"></i> حفظ العميل</button>
            </div>

            <div id="owner-meals" class="hidden">
                <h2><i class="fas fa-users"></i> إدارة العملاء والدايت</h2>
                <input type="text" id="client-search" placeholder="ابحث عن عميل" onkeyup="searchClient()">
                <div id="search-results" class="category hidden"></div>
                <div class="category" id="subscription-stats">
                    <h2><i class="fas fa-chart-bar"></i> إحصائيات الاشتراكات</h2>
                    <p>عدد المشتركين: <span id="active-clients">0</span></p>
                    <p>الاشتراكات الملغاة: <span id="canceled-clients">0</span></p>
                    <button onclick="exportSubscriptionReport('daily')">تقرير يومي</button>
                    <button onclick="exportSubscriptionReport('weekly')">تقرير أسبوعي</button>
                    <button onclick="exportSubscriptionReport('monthly')">تقرير شهري</button>
                    <button onclick="exportSubscriptionReport('yearly')">تقرير سنوي</button>
                </div>
                <div class="category" id="expiring-subscriptions">
                    <h2><i class="fas fa-clock"></i> اشتراكات على وشك الانتهاء</h2>
                    <div id="expiring-list"></div>
                </div>
                <select id="client-selector" onchange="loadOwnerClientData()">
                    <option value="">اختر عميل</option>
                </select>
                <div id="client-details"></div>
                <div id="client-macros"></div>
                <div class="spinner" id="loading-spinner"></div>
                <button onclick="addMeal()"><i class="fas fa-plus"></i> إضافة وجبة</button>
                <button onclick="showCustomFoodForm()"><i class="fas fa-utensils"></i> إضافة طعام مخصص</button>
                <div id="meals-container"></div>
                <button onclick="shareClientLink()"><i class="fas fa-share-alt"></i> مشاركة للعميل</button>
                <button onclick="exportOwnerClientReport('daily')"><i class="fas fa-file-pdf"></i> Daily Report</button>
                <button onclick="exportOwnerClientReport('weekly')"><i class="fas fa-file-pdf"></i> Weekly Report</button>
                <button onclick="exportOwnerClientReport('monthly')"><i class="fas fa-file-pdf"></i> Monthly Report</button>
                <button onclick="showNotificationForm()"><i class="fas fa-bell"></i> إرسال إشعار</button>
            </div>
        </div>

        <div class="client-only hidden" id="client-interface">
            <div class="stats">
                <div class="stat-box"><h3><i class="fas fa-fire"></i> السعرات المتبقية</h3><p id="client-calories">0</p></div>
                <div class="stat-box"><h3><i class="fas fa-bread-slice"></i> الكارب (جم)</h3><p id="client-carbs">0</p></div>
                <div class="stat-box"><h3><i class="fas fa-drumstick-bite"></i> البروتين (جم)</h3><p id="client-protein">0</p></div>
                <div class="stat-box"><h3><i class="fas fa-cheese"></i> الدهون (جم)</h3><p id="client-fats">0</p></div>
                <div class="stat-box"><h3><i class="fas fa-seedling"></i> الألياف (جم)</h3><p id="client-fiber">0</p></div>
                <div class="stat-box"><h3><i class="fas fa-star"></i> النقاط</h3><p id="client-points">0</p></div>
            </div>

            <div class="performance-stats" id="performance-stats">
                <div class="stat-box"><h3><i class="fas fa-check-circle"></i> الوجبات المكتملة</h3><p id="completed-meals">0</p></div>
                <div class="stat-box"><h3><i class="fas fa-trophy"></i> إجمالي النقاط</h3><p id="total-points">0</p></div>
                <div class="stat-box"><h3><i class="fas fa-chart-line"></i> متوسط السعرات</h3><p id="avg-calories">0</p></div>
            </div>

            <div id="client-meals" class="meals">
                <div id="completion-time" class="hidden"></div>
            </div>

            <div class="category">
                <h2><i class="fas fa-file-export"></i> تصدير التقارير</h2>
                <button onclick="exportClientReport('daily')"><i class="fas fa-file-pdf"></i> Daily Report</button>
                <button onclick="exportClientReport('weekly')"><i class="fas fa-file-pdf"></i> Weekly Report</button>
                <button onclick="exportClientReport('monthly')"><i class="fas fa-file-pdf"></i> Monthly Report</button>
            </div>

            <div class="category" id="client-notifications">
                <h2><i class="fas fa-bell"></i> الإشعارات</h2>
                <div id="notifications-list"></div>
            </div>

            <div class="category">
                <h2><i class="fas fa-clock"></i> اقتراحات توقيت الوجبات</h2>
                <div id="meal-timing-suggestions"></div>
            </div>

            <div class="category">
                <button onclick="logout()"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</button>
            </div>

            <div id="chart-container"><canvas id="macrosChart"></canvas></div>
        </div>

        <div id="food-modal" class="modal hidden">
            <div class="modal-content">
                <span class="close-modal" onclick="closeModal('food-modal')">×</span>
                <h3><i class="fas fa-utensils"></i> إضافة طعام</h3>
                <select id="modal-food-type" onchange="updateModalFoodOptions()">
                    <option value="">اختر نوع الطعام</option>
                    <option value="carbs">كربوهيدرات</option>
                    <option value="protein">بروتين</option>
                    <option value="fats">دهون</option>
                    <option value="custom">مخصص</option>
                </select>
                <input type="text" id="modal-food-search" placeholder="ابحث عن طعام" onkeyup="searchFood()">
                <select id="modal-food-name"><option value="">اختر الطعام</option></select>
                <select id="modal-unit">
                    <option value="spoon">ملعقة</option>
                    <option value="cup">كوب</option>
                    <option value="count">عدد</option>
                    <option value="grams">جرام</option>
                    <option value="ml">مل</option>
                </select>
                <select id="modal-size">
                    <option value="small">صغير</option>
                    <option value="medium">متوسط</option>
                    <option value="large">كبير</option>
                </select>
                <input type="number" id="modal-quantity" placeholder="الكمية" min="1" value="1">
                <button onclick="addFoodFromModal()"><i class="fas fa-plus"></i> إضافة</button>
            </div>
        </div>

        <div id="custom-food-modal" class="modal hidden">
            <div class="modal-content">
                <span class="close-modal" onclick="closeModal('custom-food-modal')">×</span>
                <h3><i class="fas fa-utensils"></i> إضافة طعام مخصص</h3>
                <input type="text" id="custom-food-name" placeholder="اسم الطعام">
                <input type="number" id="custom-food-calories" placeholder="السعرات">
                <input type="number" id="custom-food-carbs" placeholder="الكارب (جم)">
                <input type="number" id="custom-food-protein" placeholder="البروتين (جم)">
                <input type="number" id="custom-food-fats" placeholder="الدهون (جم)">
                <input type="number" id="custom-food-fiber" placeholder="الألياف (جم)">
                <input type="number" id="custom-food-base-grams" placeholder="الوزن الأساسي (جم)">
                <input type="text" id="custom-food-vitamins" placeholder="الفيتامينات (اختياري)">
                <button onclick="addCustomFoodFromModal()"><i class="fas fa-save"></i> حفظ الطعام</button>
            </div>
        </div>

        <div id="notification-modal" class="modal hidden">
            <div class="modal-content">
                <span class="close-modal" onclick="closeModal('notification-modal')">×</span>
                <h3><i class="fas fa-bell"></i> إرسال إشعار للعميل</h3>
                <input type="text" id="notification-title" placeholder="عنوان الإشعار">
                <textarea id="notification-message" placeholder="الرسالة"></textarea>
                <button onclick="sendNotification()"><i class="fas fa-paper-plane"></i> إرسال</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        const { jsPDF } = window.jspdf;

        let isOwnerLoggedIn = false;
        let currentUserType = null;
        let currentClientId = null;
        let currentMealIndex = null;
        let chartInstance = null;

        function simpleSHA256(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString(16);
        }

        const OWNER_CREDENTIALS = { usernameHash: simpleSHA256("admin"), passwordHash: simpleSHA256("123456") };

        let foodDatabase = {
            carbs: [
                { name: "عيش بلدي", calories: 150, carbs: 30, protein: 5, fat: 1, fiber: 2, vitamins: "B1", baseGrams: 50, units: { spoon: 10, cup: 100, count: 50, grams: 1, ml: 0 } },
                { name: "أرز مصري", calories: 130, carbs: 28, protein: 2.5, fat: 0.5, fiber: 0.5, vitamins: "B3", baseGrams: 100, units: { spoon: 15, cup: 200, count: 100, grams: 1, ml: 0 } }
            ],
            protein: [
                { name: "فراخ مشوية", calories: 165, carbs: 0, protein: 31, fat: 4, fiber: 0, vitamins: "B3", baseGrams: 100, units: { spoon: 20, cup: 150, count: 100, grams: 1, ml: 0 } },
                { name: "سمك بلطي", calories: 128, carbs: 0, protein: 26, fat: 3, fiber: 0, vitamins: "D", baseGrams: 100, units: { spoon: 20, cup: 150, count: 100, grams: 1, ml: 0 } }
            ],
            fats: [
                { name: "زيت زيتون", calories: 884, carbs: 0, protein: 0, fat: 100, fiber: 0, vitamins: "E", baseGrams: 100, units: { spoon: 15, cup: 200, count: 0, grams: 1, ml: 1 } },
                { name: "زبدة", calories: 717, carbs: 0, protein: 1, fat: 81, fiber: 0, vitamins: "A", baseGrams: 100, units: { spoon: 15, cup: 200, count: 0, grams: 1, ml: 0 } },
                { name: "لوز", calories: 579, carbs: 22, protein: 21, fat: 50, fiber: 13, vitamins: "E", baseGrams: 100, units: { spoon: 10, cup: 150, count: 100, grams: 1, ml: 0 } }
            ]
        };

        let clients = JSON.parse(localStorage.getItem("clients")) || {};
        let customFoods = JSON.parse(localStorage.getItem("customFoods")) || [];
    </script>
</body>
</html><script>
    // تابع الـ JavaScript من الجزء الأول

    function login() {
        const userType = document.getElementById("user-type").value;
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;
        const usernameHash = simpleSHA256(username);
        const passwordHash = simpleSHA256(password);

        if (userType === "owner" && usernameHash === OWNER_CREDENTIALS.usernameHash && passwordHash === OWNER_CREDENTIALS.passwordHash) {
            isOwnerLoggedIn = true;
            currentUserType = "owner";
            showOwnerInterface();
        } else if (userType === "client" && clients[username] && clients[username].passwordHash === passwordHash) {
            isOwnerLoggedIn = false;
            currentUserType = "client";
            currentClientId = username;
            showClientInterface();
        } else {
            alert("اسم المستخدم أو كلمة المرور غير صحيحة!");
        }
    }

    function showOwnerInterface() {
        document.getElementById("login-screen").classList.add("hidden");
        document.getElementById("navbar").classList.remove("hidden");
        document.getElementById("breadcrumbs").classList.remove("hidden");
        document.getElementById("owner-interface").classList.remove("hidden");
        document.getElementById("client-interface").classList.add("hidden");
        showSection("owner-meals");
        loadClientSelector();
        loadSubscriptionStats();
        loadExpiringSubscriptions();
    }

    function showClientInterface() {
        document.getElementById("login-screen").classList.add("hidden");
        document.getElementById("navbar").classList.add("hidden");
        document.getElementById("breadcrumbs").classList.add("hidden");
        document.getElementById("owner-interface").classList.add("hidden");
        document.getElementById("client-interface").classList.remove("hidden");
        loadClientData();
    }

    function loadClientSelector() {
        const selector = document.getElementById("client-selector");
        selector.innerHTML = '<option value="">اختر عميل</option>';
        Object.keys(clients).forEach(clientId => {
            const option = document.createElement("option");
            option.value = clientId;
            option.textContent = clientId;
            selector.appendChild(option);
        });
    }

    function addClient() {
        const username = document.getElementById("client-username").value;
        const password = document.getElementById("client-password").value;
        if (!username || !password) {
            alert("يرجى ملء جميع الحقول الأساسية!");
            return;
        }
        if (clients[username]) {
            alert("اسم المستخدم موجود بالفعل!");
            return;
        }

        const usageDays = parseInt(document.getElementById("usage-days").value) || 30;
        const subscriptionEndDate = new Date();
        subscriptionEndDate.setDate(subscriptionEndDate.getDate() + usageDays);

        const clientData = {
            passwordHash: simpleSHA256(password),
            password: password,
            age: parseInt(document.getElementById("client-age").value) || 30,
            height: parseInt(document.getElementById("client-height").value) || 170,
            weight: parseInt(document.getElementById("client-weight").value) || 70,
            gender: document.getElementById("client-gender").value,
            activity: parseFloat(document.getElementById("client-activity").value),
            goal: document.getElementById("client-goal").value,
            targetCalories: parseInt(document.getElementById("target-calories").value) || calculateBMR(username),
            macros: {
                protein: parseInt(document.getElementById("protein-grams").value) || 0,
                carbs: parseInt(document.getElementById("carbs-grams").value) || 0,
                fats: parseInt(document.getElementById("fats-grams").value) || 0,
                fiber: parseInt(document.getElementById("fiber-grams").value) || 0
            },
            usageDays: usageDays,
            subscriptionEndDate: subscriptionEndDate.toISOString(),
            lifestyle: document.getElementById("client-lifestyle").value,
            meals: [],
            completedMeals: [],
            notifications: [],
            points: 0,
            totalPoints: 0,
            dailyRecords: [],
            canceled: false
        };
        clients[username] = clientData;
        localStorage.setItem("clients", JSON.stringify(clients));
        alert("تم إضافة العميل بنجاح!");
        loadClientSelector();
        loadSubscriptionStats();
        loadExpiringSubscriptions();
        showSection("owner-meals");
    }

    function calculateBMR(clientId) {
        const client = clients[clientId];
        let bmr = client.gender === "male" ?
            10 * client.weight + 6.25 * client.height - 5 * client.age + 5 :
            10 * client.weight + 6.25 * client.height - 5 * client.age - 161;
        bmr *= client.activity;
        if (client.goal === "loss") bmr -= 500;
        else if (client.goal === "gain") bmr += 500;
        return Math.round(bmr);
    }

    function showSection(sectionId) {
        document.querySelectorAll(".owner-only > div").forEach(div => div.classList.add("hidden"));
        document.getElementById(sectionId).classList.remove("hidden");
        document.getElementById("breadcrumbs").textContent = sectionId === "owner-meals" ? "الرئيسية > إدارة العملاء" : "الرئيسية > إضافة عميل";
    }

    function loadOwnerClientData() {
        const clientId = document.getElementById("client-selector").value;
        if (!clientId) return;
        currentClientId = clientId;
        const client = clients[clientId];
        const detailsDiv = document.getElementById("client-details");
        detailsDiv.innerHTML = `
            <h3>تفاصيل العميل: ${clientId}</h3>
            <p>العمر: ${client.age} | الطول: ${client.height} سم | الوزن: ${client.weight} كجم</p>
            <p>الهدف: ${client.goal === "loss" ? "فقدان الوزن" : client.goal === "gain" ? "زيادة الوزن" : "المحافظة"}</p>
            <p>السعرات المستهدفة: ${client.targetCalories} سعرة</p>
            <p>تاريخ انتهاء الاشتراك: ${new Date(client.subscriptionEndDate).toLocaleDateString()}</p>
            <p>كلمة المرور: ${client.password}</p>
        `;
        const macrosDiv = document.getElementById("client-macros");
        macrosDiv.innerHTML = `
            <h3>الماكروز المستهدفة</h3>
            <p>بروتين: ${client.macros.protein} جم | كارب: ${client.macros.carbs} جم | دهون: ${client.macros.fats} جم | ألياف: ${client.macros.fiber} جم</p>
        `;
        loadMeals(clientId, "meals-container");
    }

    function loadClientData() {
        const client = clients[currentClientId];
        const remainingCalories = client.targetCalories - calculateDailyCalories(client.meals);
        document.getElementById("client-calories").textContent = remainingCalories;
        document.getElementById("client-protein").textContent = client.macros.protein - calculateDailyMacros(client.meals, "protein");
        document.getElementById("client-carbs").textContent = client.macros.carbs - calculateDailyMacros(client.meals, "carbs");
        document.getElementById("client-fats").textContent = client.macros.fats - calculateDailyMacros(client.meals, "fats");
        document.getElementById("client-fiber").textContent = client.macros.fiber - calculateDailyMacros(client.meals, "fiber");
        document.getElementById("client-points").textContent = client.points;
        loadPerformanceStats(client);
        loadMeals(currentClientId, "client-meals");
        loadNotifications(client);
        suggestMealTiming(client);
        updateChart(client);
    }

    function calculateDailyCalories(meals) {
        return meals.reduce((total, meal) => total + meal.foods.reduce((sum, food) => sum + food.calories, 0), 0);
    }

    function calculateDailyMacros(meals, macro) {
        return meals.reduce((total, meal) => total + meal.foods.reduce((sum, food) => sum + (food[macro] || 0), 0), 0);
    }

    function loadMeals(clientId, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        const client = clients[clientId];
        client.meals.forEach((meal, index) => {
            const mealDiv = document.createElement("div");
            mealDiv.className = "meal-box" + (meal.completed ? " completed" : "");
            mealDiv.innerHTML = `
                <h3>وجبة ${index + 1} ${meal.completed ? '<i class="fas fa-check checkmark"></i>' : ''}</h3>
                <div>${meal.foods.map((food, foodIndex) => `
                    <div class="food-item ${food.completed ? 'completed' : ''}">
                        ${food.name} (${food.quantity} ${food.unit === "spoon" ? "ملعقة" : food.unit === "cup" ? "كوب" : food.unit === "count" ? "عدد" : food.unit === "grams" ? "جم" : "مل"}) - 
                        ${food.calories} سعرة
                        ${isOwnerLoggedIn ? `<button onclick="removeFood(${index}, ${foodIndex})"><i class="fas fa-trash"></i></button>` : 
                        `<button onclick="toggleFoodCompletion('${clientId}', ${index}, ${foodIndex})"><i class="fas fa-check"></i></button>`}
                    </div>`).join("")}</div>
                ${isOwnerLoggedIn ? `
                    <button onclick="showFoodModal(${index})"><i class="fas fa-plus"></i> إضافة طعام</button>
                    <button onclick="removeMeal(${index})"><i class="fas fa-trash-alt"></i> حذف الوجبة</button>
                ` : `<button onclick="markMealCompleted('${clientId}', ${index})"><i class="fas fa-check-circle"></i> إكمال الوجبة</button>`}
            `;
            container.appendChild(mealDiv);
        });
    }

    function addMeal() {
        if (!currentClientId) return;
        clients[currentClientId].meals.push({ foods: [], completed: false });
        localStorage.setItem("clients", JSON.stringify(clients));
        loadOwnerClientData();
    }

    function removeMeal(mealIndex) {
        if (confirm("هل أنت متأكد من حذف هذه الوجبة؟")) {
            clients[currentClientId].meals.splice(mealIndex, 1);
            localStorage.setItem("clients", JSON.stringify(clients));
            loadOwnerClientData();
        }
    }

    function showFoodModal(mealIndex) {
        currentMealIndex = mealIndex;
        document.getElementById("food-modal").classList.remove("hidden");
        updateModalFoodOptions();
    }

    function updateModalFoodOptions() {
        const foodType = document.getElementById("modal-food-type").value;
        const foodSelect = document.getElementById("modal-food-name");
        foodSelect.innerHTML = '<option value="">اختر الطعام</option>';
        let foods = foodType === "custom" ? customFoods : foodDatabase[foodType] || [];
        foods.forEach(food => {
            const option = document.createElement("option");
            option.value = food.name;
            option.textContent = food.name;
            foodSelect.appendChild(option);
        });
    }

    function searchFood() {
        const searchTerm = document.getElementById("modal-food-search").value.toLowerCase();
        const foodType = document.getElementById("modal-food-type").value;
        const foodSelect = document.getElementById("modal-food-name");
        foodSelect.innerHTML = '<option value="">اختر الطعام</option>';
        let foods = foodType === "custom" ? customFoods : foodDatabase[foodType] || [];
        foods.filter(food => food.name.toLowerCase().includes(searchTerm)).forEach(food => {
            const option = document.createElement("option");
            option.value = food.name;
            option.textContent = food.name;
            foodSelect.appendChild(option);
        });
    }

    function addFoodFromModal() {
        const foodName = document.getElementById("modal-food-name").value;
        const unit = document.getElementById("modal-unit").value;
        const size = document.getElementById("modal-size").value;
        const quantity = parseInt(document.getElementById("modal-quantity").value);
        if (!foodName || !quantity) return;

        let food = [...foodDatabase.carbs, ...foodDatabase.protein, ...foodDatabase.fats, ...customFoods].find(f => f.name === foodName);
        if (!food) return;

        const sizeFactor = size === "small" ? 0.5 : size === "large" ? 1.5 : 1;
        const unitGrams = food.units[unit] || 1;
        const totalGrams = unitGrams * quantity * sizeFactor;
        const factor = totalGrams / food.baseGrams;

        const foodData = {
            name: food.name,
            calories: Math.round(food.calories * factor),
            carbs: Math.round((food.carbs || 0) * factor),
            protein: Math.round((food.protein || 0) * factor),
            fat: Math.round((food.fat || 0) * factor),
            fiber: Math.round((food.fiber || 0) * factor),
            unit,
            quantity,
            size,
            completed: false
        };

        clients[currentClientId].meals[currentMealIndex].foods.push(foodData);
        localStorage.setItem("clients", JSON.stringify(clients));
        closeModal("food-modal");
        loadOwnerClientData();
    }

    function removeFood(mealIndex, foodIndex) {
        clients[currentClientId].meals[mealIndex].foods.splice(foodIndex, 1);
        localStorage.setItem("clients", JSON.stringify(clients));
        loadOwnerClientData();
    }

    function toggleFoodCompletion(clientId, mealIndex, foodIndex) {
        const food = clients[clientId].meals[mealIndex].foods[foodIndex];
        food.completed = !food.completed;
        if (food.completed) clients[clientId].points += 5;
        localStorage.setItem("clients", JSON.stringify(clients));
        loadClientData();
    }

    function markMealCompleted(clientId, mealIndex) {
        const meal = clients[clientId].meals[mealIndex];
        meal.completed = true;
        meal.foods.forEach(food => food.completed = true);
        const completionTime = new Date().toLocaleString();
        meal.completionTime = completionTime;
        clients[clientId].completedMeals.push({ ...meal, date: completionTime });
        clients[clientId].points += 20;
        clients[clientId].totalPoints += 20;
        if (clients[clientId].meals.every(m => m.completed)) {
            document.getElementById("completion-time").classList.remove("hidden");
            document.getElementById("completion-time").innerHTML = `<p>تم إكمال كل الوجبات في: ${completionTime}</p>`;
        }
        localStorage.setItem("clients", JSON.stringify(clients));
        loadClientData();
    }

    function showCustomFoodForm() {
        document.getElementById("custom-food-modal").classList.remove("hidden");
    }

    function addCustomFoodFromModal() {
        const foodData = {
            name: document.getElementById("custom-food-name").value,
            calories: parseInt(document.getElementById("custom-food-calories").value) || 0,
            carbs: parseInt(document.getElementById("custom-food-carbs").value) || 0,
            protein: parseInt(document.getElementById("custom-food-protein").value) || 0,
            fat: parseInt(document.getElementById("custom-food-fats").value) || 0,
            fiber: parseInt(document.getElementById("custom-food-fiber").value) || 0,
            baseGrams: parseInt(document.getElementById("custom-food-base-grams").value) || 100,
            vitamins: document.getElementById("custom-food-vitamins").value || "",
            units: { spoon: 15, cup: 150, count: 100, grams: 1, ml: 1 }
        };
        if (!foodData.name || !foodData.calories) return;
        customFoods.push(foodData);
        localStorage.setItem("customFoods", JSON.stringify(customFoods));
        closeModal("custom-food-modal");
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.add("hidden");
    }

    function exportOwnerClientReport(type) {
        if (!currentClientId) return;
        const client = clients[currentClientId];
        const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
        doc.setFontSize(16);
        doc.text(`${type.charAt(0).toUpperCase() + type.slice(1)} Report for Client: ${currentClientId}`, 105, 20, { align: "center" });
        doc.setFontSize(12);
        let y = 30;
        doc.text(`Target Calories: ${client.targetCalories}`, 190, y, { align: "right" });
        y += 10;
        doc.text(`Macros: Protein ${client.macros.protein}g | Carbs ${client.macros.carbs}g | Fats ${client.macros.fats}g`, 190, y, { align: "right" });
        y += 10;
        client.meals.forEach((meal, index) => {
            doc.text(`Meal ${index + 1}${meal.completed ? " (Completed)" : ""}`, 190, y, { align: "right" });
            y += 10;
            meal.foods.forEach(food => {
                doc.text(`${food.name}: ${food.quantity} ${food.unit} - ${food.calories} cal`, 180, y, { align: "right" });
                y += 10;
            });
        });
        doc.save(`${currentClientId}_${type}_report.pdf`);
    }

    function exportClientReport(type) {
        const client = clients[currentClientId];
        const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
        doc.setFontSize(16);
        doc.text(`${type.charAt(0).toUpperCase() + type.slice(1)} Report`, 105, 20, { align: "center" });
        doc.setFontSize(12);
        let y = 30;
        doc.text(`Remaining Calories: ${client.targetCalories - calculateDailyCalories(client.meals)}`, 190, y, { align: "right" });
        y += 10;
        doc.text(`Points: ${client.points}`, 190, y, { align: "right" });
        y += 10;
        client.meals.forEach((meal, index) => {
            doc.text(`Meal ${index + 1}${meal.completed ? " (Completed)" : ""}`, 190, y, { align: "right" });
            y += 10;
            meal.foods.forEach(food => {
                doc.text(`${food.name}: ${food.quantity} ${food.unit} - ${food.calories} cal`, 180, y, { align: "right" });
                y += 10;
            });
        });
        doc.save(`${currentClientId}_${type}_report.pdf`);
    }

    function loadPerformanceStats(client) {
        const completedMeals = client.completedMeals.length;
        const totalPoints = client.totalPoints;
        const avgCalories = client.dailyRecords.length ? (client.dailyRecords.reduce((sum, record) => sum + record.calories, 0) / client.dailyRecords.length).toFixed(0) : 0;
        document.getElementById("completed-meals").textContent = completedMeals;
        document.getElementById("total-points").textContent = totalPoints;
        document.getElementById("avg-calories").textContent = avgCalories;
    }

    function showNotificationForm() {
        document.getElementById("notification-modal").classList.remove("hidden");
    }

    function sendNotification() {
        const title = document.getElementById("notification-title").value;
        const message = document.getElementById("notification-message").value;
        if (!title || !message || !currentClientId) return;
        clients[currentClientId].notifications.push({ title, message, date: new Date().toISOString() });
        localStorage.setItem("clients", JSON.stringify(clients));
        closeModal("notification-modal");
        alert("تم إرسال الإشعار!");
    }

    function loadNotifications(client) {
        const container = document.getElementById("notifications-list");
        container.innerHTML = "";
        client.notifications.forEach(notif => {
            const div = document.createElement("div");
            div.innerHTML = `<strong>${notif.title}</strong><p>${notif.message} - ${new Date(notif.date).toLocaleString()}</p>`;
            container.appendChild(div);
        });
    }

    function suggestMealTiming(client) {
        const container = document.getElementById("meal-timing-suggestions");
        container.innerHTML = "";
        const lifestyle = client.lifestyle;
        let times = lifestyle === "sedentary" ? ["08:00", "12:00", "16:00", "20:00"] :
                    lifestyle === "active" ? ["07:00", "10:00", "13:00", "16:00", "19:00"] :
                    ["07:30", "11:00", "14:30", "18:00"];
        client.meals.forEach((meal, index) => {
            const time = times[index % times.length];
            const div = document.createElement("div");
            div.textContent = `وجبة ${index + 1}: ${time}`;
            container.appendChild(div);
        });
    }

    function updateChart(client) {
        const ctx = document.getElementById("macrosChart").getContext("2d");
        document.getElementById("chart-container").style.display = "block";
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: "bar",
            data: {
                labels: ["بروتين", "كارب", "دهون", "ألياف"],
                datasets: [{
                    label: "المستهلك",
                    data: [
                        calculateDailyMacros(client.meals, "protein"),
                        calculateDailyMacros(client.meals, "carbs"),
                        calculateDailyMacros(client.meals, "fat"),
                        calculateDailyMacros(client.meals, "fiber")
                    ],
                    backgroundColor: "rgba(2, 136, 209, 0.5)"
                }, {
                    label: "المستهدف",
                    data: [client.macros.protein, client.macros.carbs, client.macros.fats, client.macros.fiber],
                    backgroundColor: "rgba(76, 175, 80, 0.5)"
                }]
            },
            options: { scales: { y: { beginAtZero: true } } }
        });
    }

    function toggleTheme() {
        document.body.classList.toggle("dark-mode");
        document.querySelector(".container").classList.toggle("dark-mode");
        document.querySelectorAll(".login-container, .stats, .meals, .category, .performance-stats, #chart-container").forEach(el => el.classList.toggle("dark-mode"));
        document.querySelectorAll(".login-box, .stat-box, .meal-box, .food-item, .modal-content").forEach(el => el.classList.toggle("dark-mode"));
    }

    function clearDatabase() {
        if (confirm("هل أنت متأكد من حذف جميع البيانات؟")) {
            localStorage.clear();
            clients = {};
            customFoods = [];
            alert("تم حذف جميع البيانات!");
            logout();
        }
    }

    function shareClientLink() {
        if (!currentClientId) return;
        const link = `${window.location.origin}?client=${currentClientId}`;
        navigator.clipboard.writeText(link).then(() => alert("تم نسخ الرابط إلى الحافظة!"));
    }

    function logout() {
        isOwnerLoggedIn = false;
        currentUserType = null;
        currentClientId = null;
        document.getElementById("login-screen").classList.remove("hidden");
        document.getElementById("navbar").classList.add("hidden");
        document.getElementById("breadcrumbs").classList.add("hidden");
        document.getElementById("owner-interface").classList.add("hidden");
        document.getElementById("client-interface").classList.add("hidden");
    }

    function searchClient() {
        const searchTerm = document.getElementById("client-search").value.toLowerCase();
        const resultsDiv = document.getElementById("search-results");
        resultsDiv.innerHTML = "";
        if (!searchTerm) {
            resultsDiv.classList.add("hidden");
            return;
        }
        resultsDiv.classList.remove("hidden");
        Object.entries(clients).filter(([id]) => id.toLowerCase().includes(searchTerm)).forEach(([id, client]) => {
            const div = document.createElement("div");
            div.innerHTML = `
                <p><strong>${id}</strong> - Password: ${client.password}</p>
                <p>Age: ${client.age} | Height: ${client.height} cm | Weight: ${client.weight} kg</p>
                <p>Subscription End: ${new Date(client.subscriptionEndDate).toLocaleDateString()}</p>
            `;
            resultsDiv.appendChild(div);
        });
    }

    function loadSubscriptionStats() {
        const activeClients = Object.values(clients).filter(c => !c.canceled).length;
        const canceledClients = Object.values(clients).filter(c => c.canceled).length;
        document.getElementById("active-clients").textContent = activeClients;
        document.getElementById("canceled-clients").textContent = canceledClients;
    }

    function loadExpiringSubscriptions() {
        const expiringList = document.getElementById("expiring-list");
        expiringList.innerHTML = "";
        const now = new Date();
        const weekFromNow = new Date(now);
        weekFromNow.setDate(now.getDate() + 7);
        Object.entries(clients).filter(([_, client]) => {
            const endDate = new Date(client.subscriptionEndDate);
            return !client.canceled && endDate <= weekFromNow && endDate >= now;
        }).forEach(([id, client]) => {
            const div = document.createElement("div");
            div.innerHTML = `<p>${id} - Ends: ${new Date(client.subscriptionEndDate).toLocaleDateString()}</p>`;
            expiringList.appendChild(div);
        });
    }

    function exportSubscriptionReport(type) {
        const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
        doc.setFontSize(16);
        doc.text(`${type.charAt(0).toUpperCase() + type.slice(1)} Subscription Report`, 105, 20, { align: "center" });
        doc.setFontSize(12);
        let y = 30;
        doc.text(`Active Clients: ${Object.values(clients).filter(c => !c.canceled).length}`, 190, y, { align: "right" });
        y += 10;
        doc.text(`Canceled Clients: ${Object.values(clients).filter(c => c.canceled).length}`, 190, y, { align: "right" });
        y += 10;
        Object.entries(clients).forEach(([id, client]) => {
            doc.text(`${id}: Ends ${new Date(client.subscriptionEndDate).toLocaleDateString()} ${client.canceled ? "(Canceled)" : ""}`, 190, y, { align: "right" });
            y += 10;
        });
        doc.save(`subscription_${type}_report.pdf`);
    }

    window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const clientId = urlParams.get("client");
        if (clientId && clients[clientId]) {
            document.getElementById("username").value = clientId;
            document.getElementById("user-type").value = "client";
        }
    };
</script><style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Arial', sans-serif; background: linear-gradient(135deg, #e0f7fa, #b2ebf2); padding: 15px; }
    body.dark-mode { background: linear-gradient(135deg, #263238, #455a64); color: #eceff1; }
    .container { max-width: 1600px; margin: 20px auto; background: #fff; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
    .container.dark-mode { background: #37474f; }
    .navbar { display: flex; justify-content: space-around; background: #0288d1; padding: 15px; border-radius: 12px; }
    .nav-item { color: white; cursor: pointer; padding: 10px 20px; border-radius: 10px; transition: background 0.3s; }
    .nav-item:hover { background: #0277bd; }
    .header h1 { color: #0277bd; font-size: 2.5em; text-align: center; margin-bottom: 20px; }
    .header h1.dark-mode { color: #4fc3f7; }
    .breadcrumbs { color: #0288d1; margin: 10px 0; font-size: 1.1em; }
    .breadcrumbs.dark-mode { color: #4fc3f7; }
    .login-container, .stats, .calculator, .owner-options, .meals, .category, .performance-stats, #chart-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin: 20px 0; }
    .login-container.dark-mode, .stats.dark-mode, .calculator.dark-mode, .owner-options.dark-mode, .meals.dark-mode, .category.dark-mode, .performance-stats.dark-mode, #chart-container.dark-mode { background: #455a64; }
    .login-box, .stat-box, .calc-box, .option-box, .meal-box, .modal-content { background: #e1f5fe; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: transform 0.3s; }
    .login-box.dark-mode, .stat-box.dark-mode, .calc-box.dark-mode, .option-box.dark-mode, .meal-box.dark-mode, .modal-content.dark-mode { background: #546e7a; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .login-box:hover, .stat-box:hover, .calc-box:hover, .option-box:hover, .meal-box:hover { transform: translateY(-5px); }
    h1, h2, h3 { color: #0277bd; margin-bottom: 15px; }
    h1.dark-mode, h2.dark-mode, h3.dark-mode { color: #4fc3f7; }
    .hidden { display: none !important; }
    select, button, input, textarea { padding: 10px; border-radius: 8px; margin: 5px 0; width: 100%; border: 1px solid #b0bec5; font-size: 1em; }
    select.dark-mode, button.dark-mode, input.dark-mode, textarea.dark-mode { background: #607d8b; color: #eceff1; border: 1px solid #78909c; }
    button { background: #0288d1; color: white; border: none; cursor: pointer; transition: background 0.3s; }
    button:hover { background: #0277bd; }
    button.dark-mode { background: #0288d1; }
    button.dark-mode:hover { background: #0277bd; }
    .meal-box.completed { background: #c8e6c9; }
    .meal-box.completed.dark-mode { background: #4caf50; }
    .food-item.completed { text-decoration: line-through; color: #4caf50; }
    .negative { color: #d32f2f; }
    .near-target { color: #f57c00; }
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; }
    .close-modal { float: left; font-size: 1.5em; cursor: pointer; }
    .checkmark { color: #4caf50; margin-right: 10px; }
    #chart-container { margin-top: 20px; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #0288d1; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
